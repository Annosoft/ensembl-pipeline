#!/usr/local/bin/perl


=head1 NAME

Job_Tracker: Displays jobs by status, analysis id, input id or age.


=head1 SYNOPSIS

    Job_Tracker

=head1 DESCRIPTION



=head1 OPTIONS

    -anahost      host name for database (gets put as host= in locator)

    -anaport      For RDBs, what port to connect to (port= in locator)

    -anadbname    For RDBs, what name to connect to (dbname= in locator)

    -anadbuser    For RDBs, what username to connect as (dbuser= in locator)

    -anapass      For RDBs, what password to use (dbpass= in locator)
    
    -status       CREATED, SUBMITTED FAILED or SUCCESSFUL
    
    -analysis     analysis id
    
    -age          age since job status recorded in minutes

    -input        input id

=cut


use strict;

use Getopt::Long;

use Bio::EnsEMBL::DBSQL::Obj;
use Bio::EnsEMBL::Pipeline::DBSQL::Obj;
use Bio::EnsEMBL::Pipeline::DBSQL::Job;
use Bio::EnsEMBL::Pipeline::SimpleJob;
use Bio::EnsEMBL::Pipeline::RunnableDBI;
use FreezeThaw;
use Data::Dumper;

my $anahost     = 'localhost';
my $anaport     = '410000';
my $anadbname   = 'pipeline',
my $anadbuser   = 'root';
my $anapass     =  undef;
my $status      = 'FAILED';
my $analysis    = undef;
my $age         = undef;
my $input_id    = undef;

&GetOptions(
	    'anahost:s'     => \$anahost,
	    'anaport:n'     => \$anaport,
	    'anadbname:s'   => \$anadbname,
	    'anadbuser:s'   => \$anadbuser,
	    'anapass:s'     => \$anapass,
        'status:s'      => \$status,
	    'analysis:s'    => \$analysis,
	    'age:s'         => \$age,
        'input:s'       => \$input_id,
        );



my $anadb  = new Bio::EnsEMBL::Pipeline::DBSQL::Obj(-host   => $anahost,
						    -port   => $anaport,
						    -dbname => $anadbname,
						    -user   => $anadbuser,
						    -pass   => $anapass);
my @jobs;
my $title;

if ($analysis)
{
    @jobs = $anadb->get_JobsByAnalysis($analysis);
    $title = "Jobs by Analysis ID ($analysis)";
}
elsif ($age) 
{
    @jobs = $anadb->get_JobsByAge($age);
    $title = "Jobs by Age ($age min)"; 
}
elsif ($input_id)
{
    @jobs = $anadb->get_JobsByInputId($input_id);
    $title = "Jobs by Input ID ($input_id)";
}
else
{
    @jobs = $anadb->get_JobsByCurrentStatus($status);
    $title = "Jobs by Current Status ($status)";
}

my (@created, @successful, @submitted, @failed);

#sort by status
foreach my $job (@jobs)
{
    if ($job->current_status->status eq 'CREATED')
    {
        push (@created, $job); 
    }
    elsif ($job->current_status->status eq 'SUBMITTED')
    { 
        push (@submitted, $job); 
    }
    elsif ($job->current_status->status eq 'SUCCESSFUL')
    { 
        push (@successful, $job); 
    }
    elsif ($job->current_status->status eq 'FAILED')
    { 
        push (@failed, $job); 
    }
}

#print Dumper (@jobs);
print STDERR "Sorted by status: CREATED ".@created." SUBMITTED ".@submitted
      ." SUCCESSFUL ".@successful." FAILED ".@failed."\n";


print "<BODY TEXT=\"#000000\" BGCOLOR=\"#FFFFFF\">";
    print("<TABLE>\n");
    print(  "<TR>$title</TR>"
            ."<TR BGCOLOR=\"FF9966\">"
            ."<TD>CREATED (".@created.")</TD>"
            ."<TD>SUBMITTED (".@submitted.")</TD>"
            ."<TD>SUCCESSFUL (".@successful.")</TD>"
            ."<TD>FAILED (".@failed.")</TD>"
            ."</TR>"
            .(printlist(@created))
            .(printlist(@submitted))
            .(printlist(@successful))
            .(printlist(@failed))
            );
               
    print("</TABLE>\n");


sub printlist {
    my (@list) = @_;
    my $html;
    
    $html .= ("<TR BGCOLOR=\"00C155\"><TD>Status</TD><TD>Job ID</TD><TD>Analysis</TD><TD>Input ID</TD><TD>stdout</TD>"
                ."<TD>stderr</TD><TD>status</TD><TD>LSF ID</TD></TR>") if (@list);
    foreach my $job (@list)
    {
        print STDERR "Tracking job ".$job->id."\n";
        $job->_dbobj($anadb);
        $job->get_all_status;
        my $status = $job->current_status->status;
        $html .= ("<TR>"
                ."<TD> ".$status." </TD>"
                ."<TD> ".$job->id." </TD>"
                ."<TD> ".$job->analysis->program." </TD>"
                ."<TD> ".$job->input_id." </TD>"
                ."<TD><a href=\"file:". $job->stdout_file."\">stdout </a>"
                    ."(".(-s $job->stdout_file).")</TD>"
                ."<TD><a href=\"file:". $job->stderr_file."\">stderr </a>"
                    ."(".(-s $job->stderr_file).")</TD>"
                ."<TD><a href=\"file:". $job->status_file."\">status </a>"
                    ."(".(-s $job->status_file).")</TD>"
                ."<TD> ".$job->LSF_id." </TD>"
                ."</TR>"
                );   
    }
    return $html;
}











